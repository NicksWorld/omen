name: Build Linux

on:
  [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build gcc g++ ccache
      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/ccache
          key: ${{ runner.os }}-release-
      - name: Clone Omen
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Configure Omen
        run: |
          meson setup \
            -Dtests=true \
            -Dpedantic=true \
            --werror \
            --warnlevel=3 \
            --prefix="${PWD}/out" \
            build
      - name: Build Omen
        run: meson compile -C build
      - name: Finalize ccache
        run: |
          ccache --show-stats --verbose
          ccache --max-size 300MB
          ccache --zero-stats
      - name: Save ccache
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/ccache
          key: ${{ runner.os }}-release-${{ github.sha }}
      - name: Test Omen
        run: meson test -v -C build
