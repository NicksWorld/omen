name: Build Windows

on:
  [push, pull_request]

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install build dependencies
        run: |
          choco install -y ccache
          python -m pip install meson ninja
      - name: Get LocalAppData Directory
        run: echo ("LOCALAPPDATA_DIR=" + $env:LOCALAPPDATA) >> $env:GITHUB_ENV
      - name: Setup MSVC Environment
        uses: ilammy/msvc-dev-cmd@v1
      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.LOCALAPPDATA_DIR }}/ccache
          key: ${{ runner.os }}-release-
      - name: Clone Omen
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Configure Omen
        run: |
          meson setup `
            -Dtests=true `
            -Dpedantic=true `
            --werror `
            --warnlevel=3 `
            --prefix="$($PWD.Path)/out" `
            build
      - name: Build Omen
        run: meson compile -C build
      - name: Finalize ccache
        run: |
          ccache --show-stats --verbose
          ccache --max-size 300MB
          ccache --zero-stats
      - name: Save ccache
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.LOCALAPPDATA_DIR }}/ccache
          key: ${{ runner.os }}-release-${{ github.sha }}
      - name: Test Omen
        run: meson test -v -C build
